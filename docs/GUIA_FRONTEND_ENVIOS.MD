# ğŸ”„ Flujo del DTF Agent - Â¿A dÃ³nde envÃ­a los archivos?

## ğŸ“‹ Respuesta Corta

**El DTF Agent envÃ­a los archivos DIRECTAMENTE a John Deere y SEEDZ.**

**FourK API solo se usa para:**
- âœ… AutenticaciÃ³n (obtener token JWT)
- âœ… Obtener credenciales de John Deere/SEEDZ
- âœ… Obtener order_ids y transfer_ids (para PartsData)
- âœ… Marcar orders/transfers como enviados
- âœ… Crear logs de envÃ­o

**NO se envÃ­an los archivos a FourK API.**

---

## ğŸ” Flujo Detallado del DTF Agent

### Paso 1: AutenticaciÃ³n con FourK API
```
DTF Agent â†’ POST https://fourk-api.../auth/login
           â†’ Obtiene token JWT
```

**CÃ³digo:** `services/auth.py` â†’ `AuthService.get_token()`

---

### Paso 2: Obtener Credenciales desde FourK API
```
DTF Agent â†’ GET https://fourk-api.../rpm/credentials
           â†’ Obtiene: dealer_id, johndeere_client_id, secret_id
```

**CÃ³digo:** `services/credentials.py` â†’ `CredentialsService.get_credentials()`

---

### Paso 3: Obtener Token OAuth de John Deere
```
DTF Agent â†’ POST https://sso.johndeere.com/oauth2/.../token
           â†’ Usa credenciales obtenidas en Paso 2
           â†’ Obtiene token OAuth de John Deere
```

**CÃ³digo:** `services/oauth.py` â†’ `OAuthService.get_johndeere_token()`

---

### Paso 4: EnvÃ­o DIRECTO a John Deere
```
DTF Agent â†’ PUT https://servicesext.deere.com/dtfapi/dbs/dealer/{dealer_id}/files
           â†’ Headers: Authorization: Bearer {token_oauth_john_deere}
           â†’ Body: Archivo binario
           â†’ âœ… ENVÃO DIRECTO, NO pasa por FourK API
```

**CÃ³digo:** `services/direct_upload.py` â†’ `DirectUploadService.send_to_johndeere()`

---

### Paso 5: (Opcional) Obtener IDs para PartsData
Si es archivo PartsData:
```
DTF Agent â†’ GET https://fourk-api.../rpm/orders/processed
           â†’ Obtiene order_ids

DTF Agent â†’ GET https://fourk-api.../rpm/transfers/processed
           â†’ Obtiene transfer_ids
```

**CÃ³digo:** `services/credentials.py` â†’ `CredentialsService.get_partsdata_ids()`

---

### Paso 6: (Opcional) Marcar Orders/Transfers como Enviados
Si es PartsData y el envÃ­o fue exitoso:
```
DTF Agent â†’ PUT https://fourk-api.../rpm/orders/mark-sent
           â†’ Marca orders como enviados

DTF Agent â†’ PUT https://fourk-api.../rpm/transfers/mark-sent
           â†’ Marca transfers como enviados
```

**CÃ³digo:** `services/credentials.py` â†’ `mark_orders_as_sent()`, `mark_transfers_as_sent()`

---

### Paso 7: Crear Log en FourK API
```
DTF Agent â†’ POST https://fourk-api.../rpm/logs
           â†’ Crea log del envÃ­o
```

**CÃ³digo:** `services/remote_logging.py` â†’ `RemoteLoggingService.create_log()`

---

## ğŸ”„ Flujo Completo Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DTF Agent (file_sender.py)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. AutenticaciÃ³n                                            â”‚
â”‚    POST /auth/login â†’ FourK API                             â”‚
â”‚    â†’ Obtiene token JWT                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Obtener Credenciales                                     â”‚
â”‚    GET /rpm/credentials â†’ FourK API                         â”‚
â”‚    â†’ dealer_id, johndeere_client_id, secret_id            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Obtener Token OAuth                                      â”‚
â”‚    POST /oauth2/.../token â†’ John Deere                      â”‚
â”‚    â†’ Usa credenciales del paso 2                            â”‚
â”‚    â†’ Obtiene token OAuth                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ENVÃO DIRECTO DEL ARCHIVO                                â”‚
â”‚    PUT /dtfapi/dbs/dealer/{dealer_id}/files â†’ John Deere   â”‚
â”‚    â†’ Headers: Authorization: Bearer {token_oauth}          â”‚
â”‚    â†’ Body: Archivo binario                                  â”‚
â”‚    âœ… NO pasa por FourK API                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. (Si es PartsData) Obtener IDs                            â”‚
â”‚    GET /rpm/orders/processed â†’ FourK API                    â”‚
â”‚    GET /rpm/transfers/processed â†’ FourK API                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. (Si es PartsData) Marcar como Enviados                  â”‚
â”‚    PUT /rpm/orders/mark-sent â†’ FourK API                    â”‚
â”‚    PUT /rpm/transfers/mark-sent â†’ FourK API                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Crear Log                                                â”‚
â”‚    POST /rpm/logs â†’ FourK API                               â”‚
â”‚    â†’ Registra el envÃ­o                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”µ Flujo para SEEDZ

Similar a John Deere, pero:

1. **Obtener credenciales:**
   ```
   GET /seedz/credentials â†’ FourK API
   â†’ client_id_seedz, client_secret
   ```

2. **Obtener token:**
   ```
   POST /integration/v1/auth â†’ SEEDZ API
   â†’ Usa credenciales del paso 1
   â†’ Obtiene token OAuth
   ```

3. **EnvÃ­o DIRECTO:**
   ```
   POST /integration/v1/{file_type} â†’ SEEDZ API
   â†’ Headers: Authorization: Bearer {token_oauth_seedz}
   â†’ Body: JSON (convierte CSV a JSON automÃ¡ticamente)
   â†’ âœ… NO pasa por FourK API
   ```

---

## ğŸ“Š Resumen: Â¿QuÃ© va a FourK API y quÃ© va directo?

| OperaciÃ³n | Destino | PropÃ³sito |
|-----------|---------|-----------|
| AutenticaciÃ³n | FourK API | Obtener token JWT |
| Obtener credenciales | FourK API | Obtener credenciales de John Deere/SEEDZ |
| Obtener token OAuth | John Deere/SEEDZ | Obtener token para enviar archivos |
| **Enviar archivo** | **John Deere/SEEDZ** | **âœ… ENVÃO DIRECTO** |
| Obtener order_ids/transfer_ids | FourK API | Para PartsData |
| Marcar como enviados | FourK API | Actualizar estado en BD |
| Crear log | FourK API | Registrar envÃ­o |

---

## ğŸ”‘ Puntos Clave

1. **Los archivos NO pasan por FourK API**
   - Se envÃ­an directamente a John Deere o SEEDZ
   - FourK API solo proporciona credenciales

2. **FourK API es un servicio de gestiÃ³n**
   - Almacena credenciales
   - Gestiona orders/transfers
   - Registra logs
   - NO procesa ni almacena los archivos

3. **El DTF Agent es independiente**
   - Puede funcionar sin FourK API para el envÃ­o
   - Solo necesita FourK API para obtener credenciales y registrar logs

---

## ğŸ“ CÃ³digo Relevante

- **AutenticaciÃ³n:** `services/auth.py`
- **Credenciales:** `services/credentials.py`
- **OAuth:** `services/oauth.py`
- **EnvÃ­o directo:** `services/direct_upload.py`
- **OrquestaciÃ³n:** `file_sender.py` â†’ `services/uploaders.py`

---

**Ãšltima actualizaciÃ³n:** 2025-02-06
